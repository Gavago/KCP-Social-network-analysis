---
title: "SNA methods draft"
author: "nic"
date: "2/7/2020"
output: html_document
---

## Study site and data collection

We included females > 12 years and males > 15 years, as the former represented a move to reproductive maturity(?) and an end of adolescence. X unique subject-years

```{r setup, include=FALSE}
load("data/sna dataframe - individual sna measure for each year, network sex, & behavior.Rdata", verbose = TRUE)

all_sna_measure_df %>%
  distinct(chimp_id, sex, year) %>%
  group_by(sex) %>%
  tally()


```

## Data processing

#### Obs per year

1. Overall, we only included individuals that were either observed as a focal >= 100 hours, or observed as a focal for > 50 hrs AND present in social parties for at least X hours of observation.
(to be done for PO 3/2/20)
These individuals were marked to filter for short time present in year.


```{r filter sub-years: low time as focal, eval = FALSE}
#load("data/total focal and possible focal per year (2009-2010 separate).Rdata", verbose = T)
load("data/total focal and possible focal per year.Rdata", verbose = T)

lo_focal <- total_poss_focal %>%
  mutate(focal_hours = n/4) %>% #scan every 15 minutes
  filter(focal_hours < 100) %>%
  rename(focal_n = n) %>%
  select(year, ID1, focal_n, focal_hours, short_presence) %>%
  arrange(year, ID1)
  
lo_focal

nrow(lo_focal) # 112 chimp-years w lo focal observations, i.e. < 100 hrs... (a lot!!!)

# many in 2009, 2011 & 2012
lo_focal %>%
  count(year)

```

```{r filter subj-years: low time in party}
# Low time in party
load("data/focal party scans formatted.Rdata", verbose = T)
source("functions/functions - data preparation.R")

total_party_member <- foc_part %>%
  count(ID2, year) %>%
  add_individ_attr(ID1 = "ID2") %>%
  add_age(dyad = F) %>%
  filter_age(dyad = F) %>%
  mark_short_time_pres_individ() %>%
  mutate(party_hours = n/4) %>%
  rename(party_n = n) %>%
  select(year, ID1, party_n, party_hours, short_presence) %>% arrange(year, ID1)
total_party_member #number of focal scans individaul was in party


#These are chimp-years to remove, lo focal hours and and lo party hours
lo_foc_lo_party <- lo_focal %>%
  left_join(.,total_party_member, by = c("year", "ID1", "short_presence")) %>%
  mutate(party_hours = replace_na(party_hours, 0)) %>% # for GS 2011
  filter(focal_hours < 50 & party_hours < 100) #everyone else will be between 50 and 100 hrs focaled and > 100 hrs in party
lo_foc_lo_party # 4 of these are removed for short presence, 

lo_foc_lo_party %<>%
  filter(short_presence != 1)

#save(lo_foc_lo_party, file = "data/subject years to remove for low observations (focal and party membership).Rdata")

#which lo focals are saved from exclusion bc of time in party
lo_foc_hi_party <- lo_focal %>%
  left_join(total_party_member, by = c("year", "ID1", "short_presence")) %>%
  filter(party_hours >= 100)

nrow(lo_foc_hi_party) #101

lo_focal %>% anti_join(lo_foc_lo_party) %>% anti_join(lo_foc_hi_party)


```


2. Focal animal sampling began in Aug 2009. But low avg observations per individuals, so we include those observations into 2010. 
```{r justify fold 2009 into 2010, eval=FALSE}
load("data/total focal and possible focal per year (2009-2010 separate).Rdata", verbose = T)

total_poss_focal %>%
  group_by(year) %>%
  summarise(mean = mean(n), sd = sd(n), spread_relative = sd/mean, min = min(n), max = max(n))

total_poss_focal %>%
  group_by(year)%>%
  filter( n == max(n)) %>%
  arrange(year)

```

Side exploration of obs time and integration:
bc low obs, see that gmgmd indices in 2009 are oddly high (prox are somewhat higher) and several sna measures are deviant. For example, in `annual_avg_sna` can see that deg is much lower and bt much higher in 2009 than other years.

```{r 2009 as outlier among social measures, eval=FALSE}
load("data/average social measures for exploration (pre-prox filter).Rdata", verbose = T)

#indices
annual_avg_gmgmd_mixed #2009 hi
annual_avg_gmgmd_sep # and is hi for both M and F

#sna measures
annual_sna_avg %>%
  filter(behavior == "prox")
```

Time as focal always correlates with network integration, no matter range of time obs...

```{r corr time observed and }
library(ggcorrplot)
load("data/sna dataframe - individual sna measure for each year, network sex, & behavior.Rdata", verbose = TRUE)

mat <- all_sna_measure_df %>%
  left_join(.,total_focal, by = c("chimp_id" = "ID1","year")) %>%
  mutate(hours_focal = n/4, hours_focal_hi = ifelse(n/4 > 500, n/4, NA)) %>%
  select(-n) %>%
  left_join(., total_party_member, by = c("chimp_id" = "ID2", "year")) %>%
  mutate(hours_party_member = n/4, hours_party_member_hi = ifelse(n/4 > 500, n/4, NA)) %>%
  select(-n) %>%
  select(ec,bt,deg, trans, hours_focal, hours_party_member, hours_focal_hi, hours_party_member_hi) 
mat
mat %>%
  cor(.,  method = "spearman", use = "pairwise.complete.obs")
mat %>%
  cor_pmat() %>%
  round(., 2)

#seems like observation time is always correlated with network integration...
```


3. We excluded 11 subject years, where individuals were present in the community for < 6 months of a given observation year. 

```{r who was not present in community > 6 mo in given year?}
#load("data/total focal and possible focal per year (2009-2010 separate).Rdata", verbose = T)
load("data/total focal and possible focal per year.Rdata", verbose = T)
load("data/counts - gm and prox counts before removing short pres individs.Rdata", verbose = T)
source("functions/functions - data preparation.R")

sp_focal <- total_poss_focal %>%
  filter(short_presence == 1) %>%
  select(year, ID1, sex) %>%
  arrange(year, ID1)

rm_gm <- total_gm_gmdx %>%
  mark_short_time_pres() %>%
  filter(short_presence_ID1 == 1) %>%
  distinct(year, ID1) %>%
  arrange(year, ID1)

rm_5 <- total_5mx %>%
  mark_short_time_pres() %>%
  filter(short_presence_ID1 == 1) %>%
  distinct(year, ID1) %>%
  arrange(year, ID1)

cbind(sp_focal, rm_gm, rm_5) 
sp_focal %>%
 count(sex)
#none in 2009, start in 2011

```

Each network member was observed as a focal subject for an annual average +/- sd of hours.
An average of X network members per year were never observed as a focal.

```{r average obs time}

```

We calculated affiliation



------ graveyard

```{r avg obs in 2009}
load("data/total focal and possible focal per year (2009-2010 separate).Rdata", verbose = T)

total_focal %>%
  group_by(year) %>%
  summarise( mean = mean(n), sd = sd(n), spread_relative = sd/mean, max = max(n), min = min(n))

total_poss_focal %>%
  group_by(year) %>%
  summarise( mean = mean(n), sd = sd(n), spread_relative = sd/mean, max = max(n), min = min(n))

#spread in n 2010 is large
total_poss_focal %>%
  filter(year == 2013) %>%
  arrange(desc(n))


